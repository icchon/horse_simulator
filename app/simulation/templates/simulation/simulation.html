<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>機械学習モデルのパラメータ設定とグラフ表示</title>

  {% load static %}

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <link rel="stylesheet" href="{% static 'css/style.css' %}">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Kaisei+HarunoUmi&family=Kiwi+Maru&family=Kosugi+Maru&family=Sawarabi+Gothic&family=Stick&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <link href="https://use.fontawesome.com/releases/v6.4.2/css/all.css" rel="stylesheet">
</head>

<body>
  <header>
    <nav class="navbar main-content shifted">
      <div class="navbar-toggle" id="navbarToggle">
        <span class="bar"></span>
        <span class="bar"></span>
        <span class="bar"></span>
      </div>
      <div class="navbar-brand sawarabi-gothic-regular">競馬シミュレーター</div>
    </nav>
    <div class="sidebar active" id="sidebar">
      <ul class="sidebar-nav">
        <li class="nav-item">
          <a class="nav-link" href="/">
            <i class="fas fa-home"></i>
            <span>ホーム</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" aria-current="page" href="/simulation">
            <i class="fas fa-chart-line"></i>
            <span>シュミレーション</span>
          </a>
        </li>
      </ul>
    </div>
  </header>

  <main class="form-container">
    <p class="custom-font">
      機械学習を用いて競馬のレースをシミュレーションし、予測結果を表示します。
      様々なパラメータを設定することで、レースの結果がどのように変化するかを観察できます。
      また、新たな特徴量の生成も行うことができます。
    </p>
    <br>
    <br>
    <form method="post">
      {% csrf_token %}

      <div class="accordion" id="settingsAccordion">
        <!-- Features Section -->
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingOne">
            <button class="accordion-button custom-font" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
              Features : <span class="feature-description ms-2">考慮する特徴量をチェックボックスで選択してください</span>
            </button>
          </h2>
          <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#settingsAccordion">
            <div class="accordion-body">
              <div class="row">
                {% for field in form %}
                  {% if forloop.counter0|divisibleby:4 %}
                  </div><div class="col-md-3">
                  {% elif forloop.first %}
                  <div class="col-md-3">
                  {% endif %}
                    <div class="form-check">
                      <label class="custom-checkbox-label">
                        <input type="checkbox" class="form-check-input feature-checkbox" id="{{ field.id_for_label }}" name="{{ field.name }}" {% if field.value %}checked{% endif %}>
                        <span class="feature-label-text">{{ field.label }}</span>
                        <a href="#" tabindex="0" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-placement="top" data-bs-content="{{ field.help_text }}">
                          <i class="bi bi-info-circle"></i>
                        </a>
                      </label>
                    </div>
                  {% if forloop.last %}
                  </div>
                  {% endif %}
                {% endfor %}
              </div>
            </div>
          </div>
        </div>

        <!-- Generate New Features Section -->
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingTwo">
            <button class="accordion-button custom-font collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
              Generate New Features : <span class="feature-description ms-2">特徴量を組み合わせて新たな特徴量を生成できます</span>
            </button>
          </h2>
          <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#settingsAccordion">
            <div class="accordion-body">
              <div class="feature-generation">
                <div class="feature-container">
                  <div class="feature-header">
                    <h3 class="custom-font">Select Features : </h3>
                    <span class="feature-description">特徴量を選択してください</span>
                  </div>
                  <ul id="feature-list" class="feature-list">
                    <!-- This will be rendered by JavaScript -->
                  </ul>
                </div>
                <div class="generation-zone">
                  <div class="custom-font-gray">ここにドラッグアンドドロップ</div>
                  <div id="generation-list" class="generation-list custom-font-black" droppable="true">
                    <!-- This will be rendered by JavaScript -->
                  </div>
                  <div class="operator-selection" style="margin-bottom: 10px;">
                    <select id="operator-select" class="form-select">
                      <option value="*" selected>掛け算 (*)</option>
                      <option value="+">足し算 (+)</option>
                      <option value="/">割り算 (/)</option>
                    </select>
                  </div>
                  <button type="button" id="generate-button" class="btn btn-primary btn-modern">Generate</button>
                </div>
                <div class="generated-features-container">
                  <div class="feature-header">
                    <h3 class="custom-font">Generated Features : </h3>
                    <span class="feature-description">作成した特徴量</span>
                  </div>
                  <br>
                  <ul id="generated-features-list">
                    {% for feature in generated_features %}
                    <li draggable="true" data-feature="{{ feature }}">
                      {{ feature }}
                      <button class="delete-feature">delete</button>
                    </li>
                    {% endfor %}
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-between align-items-center my-4">
        <div class="feature-selection">
          <div class="feature-header">
            <h3 class="custom-font">Simulation Speed : </h3>
            <span class="feature-description">シュミレーションの速度を選択してください。速度と精度はトレードオフです</span>
          </div>
          <div class="radio-group">
            <label class="radio-option">
              <input type="radio" name="speed" value="low" checked>
              <span class="radio-text">Low</span>
            </label>
            <label class="radio-option">
              <input type="radio" name="speed" value="medium">
              <span class="radio-text">Middle</span>
            </label>
            <label class="radio-option">
              <input type="radio" name="speed" value="high">
              <span class="radio-text">High</span>
            </label>
          </div>
        </div>
        <div class="text-center">
          <button type="submit" class="btn btn-primary btn-modern custom-font">Simulate</button>
        </div>
      </div>

      <div class="form-actions text-center">
        <div id="loading" style="display: none;">
          <div class="horse-animation mx-auto"></div>
          <p>シミュレーション中...</p>
        </div>
      </div>
    </form>
    <div style="width: 800px; height: 400px; margin:0 auto;" class="graph-container text-center">
      <canvas id="resultChart"></canvas>
    </div>
    <br>
    <br>
    <div class="graph-explanation">
      <h4>グラフの見方</h4>
      <ul>
        <li>横軸は賭けた割合を表しています。０では何も賭けていないので回収率は１００％です。１では全て賭けているため、競馬の一般的な回収率の８０％弱に一致します。</li>
        <li>買う馬券は当たりそうな順に増やしていくため、減少傾向のグラフとなっています。</li>
      </ul>
    </div>
  </main>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
  {{ labels|json_script:"labels-data" }}
  {{ data|json_script:"chart-data" }}
  <script>
    // --- State Management and Rendering ---
    const state = {
      features: [],
      draggedFeatureId: null,
    };

    const featureList = document.getElementById('feature-list');
    const generationList = document.getElementById('generation-list');
    const generateButton = document.getElementById('generate-button');
    const generatedFeaturesList = document.getElementById('generated-features-list');

    function createFeatureLi(feature) {
      const li = document.createElement('li');
      li.textContent = feature.label;
      li.classList.add('feature-item');
      li.setAttribute('draggable', 'true');
      li.dataset.id = feature.id;
      return li;
    }

    function render() {
      featureList.innerHTML = '';
      generationList.innerHTML = '';

      state.features.forEach(feature => {
        if (feature.location === 'featureList') {
          featureList.appendChild(createFeatureLi(feature));
        } else if (feature.location === 'generationList') {
          generationList.appendChild(createFeatureLi(feature));
        }
      });

      state.features.forEach(feature => {
        const checkbox = document.getElementById(feature.checkboxId);
        if (checkbox) {
          checkbox.checked = feature.checked;
        }
      });
    }

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', function () {
      // Initialize state from Django form
      const featureCheckboxes = document.querySelectorAll('.feature-checkbox');
      featureCheckboxes.forEach(checkbox => {
        const labelElement = checkbox.closest('label');
        const labelTextElement = labelElement.querySelector('.feature-label-text');
        const labelText = labelTextElement ? labelTextElement.textContent.trim() : '';

        if (labelText) {
          state.features.push({
            id: checkbox.name,
            checkboxId: checkbox.id,
            label: labelText,
            checked: checkbox.checked,
            location: checkbox.checked ? 'featureList' : 'elsewhere',
          });
        }
      });
      render();

      // Forcibly check all features and update state on initial load
      state.features.forEach(feature => {
        if (!feature.checked) {
          feature.checked = true;
          feature.location = 'featureList';
        }
      });
      render(); // Re-render with the corrected state

      // --- Sidebar and Chart ---
      const navbarToggle = document.querySelector('.navbar-toggle');
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.querySelector(".main-content");
      const formContainer = document.querySelector(".form-container");

      document.addEventListener('click', function(event) {
        const isClickOnToggle = navbarToggle.contains(event.target);
        const isClickInsideSidebar = sidebar.contains(event.target);
        
        if (isClickOnToggle) {
          // Toggle sidebar
          sidebar.classList.toggle('active');
          mainContent.classList.toggle("shifted");
          formContainer.classList.toggle("shifted");
        } else if (sidebar.classList.contains('active') && !isClickInsideSidebar) {
          // Close sidebar if click is outside
          sidebar.classList.remove('active');
          mainContent.classList.remove("shifted");
          formContainer.classList.remove("shifted");
        }
      });
      
      const labelsData = document.getElementById('labels-data');
      const chartDataEl = document.getElementById('chart-data');
      const labels = labelsData ? JSON.parse(labelsData.textContent) : [];
      const chartData = chartDataEl ? JSON.parse(chartDataEl.textContent) : [];
      if (labels.length > 0 && chartData.length > 0) {
        drawChart(labels, chartData);
        document.getElementById('loading').style.display = "none";
      }
      
      var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
      popoverTriggerList.map(function (popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl, { trigger: 'focus' });
      });

      // --- Checkbox change ---
      featureCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', (event) => {
          const feature = state.features.find(f => f.checkboxId === event.target.id);
          if (feature) {
            feature.checked = event.target.checked;
            if(feature.checked) {
              feature.location = 'featureList';
            } else {
              feature.location = 'elsewhere';
            }
            render();
          }
        });
      });
    });

    // --- Click to move ---
    featureList.addEventListener('click', function(event) {
      const clickedItem = event.target.closest('.feature-item');
      if (clickedItem) {
        const feature = state.features.find(f => f.id === clickedItem.dataset.id);
        if (feature) {
          feature.location = 'generationList';
          feature.checked = false;
          render();
        }
      }
    });

    generationList.addEventListener('click', function(event) {
      const clickedItem = event.target.closest('.feature-item');
      if (clickedItem) {
        const feature = state.features.find(f => f.id === clickedItem.dataset.id);
        if (feature) {
          feature.location = 'featureList';
          feature.checked = true;
          render();
        }
      }
    });

    // --- Drag and Drop ---
    document.addEventListener('dragstart', function (event) {
      const item = event.target.closest('.feature-item');
      if (item) {
        state.draggedFeatureId = item.dataset.id;
        item.classList.add("dragging");
      }
    });

    document.addEventListener('dragend', function (event) {
        const item = event.target.closest('.feature-item');
        if (item) {
            item.classList.remove("dragging");
        }
        state.draggedFeatureId = null;
    });

    document.addEventListener('dragover', function (event) {
      event.preventDefault();
    });

    generationList.addEventListener('drop', function (event) {
      event.preventDefault();
      const feature = state.features.find(f => f.id === state.draggedFeatureId);
      if (feature) {
        feature.location = 'generationList';
        feature.checked = false;
        render();
      }
    });

    featureList.addEventListener('drop', function (event) {
      event.preventDefault();
      const feature = state.features.find(f => f.id === state.draggedFeatureId);
      if (feature) {
        feature.location = 'featureList';
        feature.checked = true;
        render();
      }
    });

    // --- Feature Generation ---
    generateButton.addEventListener('click', function (event) {
      event.preventDefault();
      const featuresToGenerate = state.features.filter(f => f.location === 'generationList');

      if (featuresToGenerate.length < 2) {
        alert("特徴量を２つ以上ドラッグアンドドロップしてください");
        return;
      }

      const operator = document.getElementById('operator-select').value;
      const operatorDisplay = ` ${operator} `;
      const newFeatureString = "・ " + featuresToGenerate.map(f => f.label).join(operatorDisplay);

      const existingFeatures = Array.from(generatedFeaturesList.children).map(item => item.firstChild.textContent.trim());
      if (existingFeatures.includes(newFeatureString)) {
        alert("この特徴量はすでに生成されています");
        return;
      }
      
      const newLi = document.createElement('li');
      newLi.setAttribute('draggable', 'true');
      newLi.dataset.feature = newFeatureString;
      newLi.innerHTML = `${newFeatureString}<button class="delete-feature custom-font">delete</button>`;
      generatedFeaturesList.appendChild(newLi);

      featuresToGenerate.forEach(feature => {
        feature.location = 'featureList';
        feature.checked = true;
      });
      render();
    });
    
    generatedFeaturesList.addEventListener('click', function (event) {
      if (event.target.classList.contains('delete-feature')) {
        event.target.parentNode.remove();
      }
    });

    // --- Form Submission ---
    document.querySelector('form').addEventListener('submit', function (event) {
      event.preventDefault();
      document.getElementById('loading').style.display = 'block';
      document.querySelector(".horse-animation").classList.add("running");

      const formElement = this;
      const jsonObject = {};
      const formData = new FormData(formElement);
      
      formData.forEach((value, key) => {
        if (key !== 'csrfmiddlewaretoken') {
          const element = formElement.elements[key];
          if (element && element.type === 'checkbox') {
            jsonObject[key] = element.checked;
          } else {
            jsonObject[key] = value;
          }
        }
      });

      const generatedFeatures = Array.from(generatedFeaturesList.querySelectorAll('li')).map(item => {
        return item.firstChild.textContent.replace(/delete\s*$/i, '').trim();
      });
      jsonObject['generated_features'] = generatedFeatures.join(',');

      fetch(this.action || window.location.href, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(jsonObject)
      })
      .then(response => response.text())
      .then(html => {
        const tempElement = document.createElement('div');
        tempElement.innerHTML = html;

        const labelsScript = tempElement.querySelector('#labels-data');
        const chartDataScript = tempElement.querySelector('#chart-data');

        if (labelsScript && chartDataScript) {
          drawChart(JSON.parse(labelsScript.textContent), JSON.parse(chartDataScript.textContent));
        }
        document.getElementById('loading').style.display = 'none';
        document.querySelector(".horse-animation").classList.remove("running");
      })
      .catch(error => {
        console.error('Error:', error);
        document.getElementById('loading').style.display = 'none';
      });
    });

    // --- Chart ---
    const ctx = document.getElementById('resultChart').getContext('2d');
    let resultChart = null;
    function drawChart(labels, chartData) {
      if (resultChart) {
        resultChart.destroy();
      }
      resultChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: '予測結果',
            data: chartData,
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1,
            fill: false
          }, {
            label: '収支０ライン',
            data: Array(labels.length).fill(100),
            borderColor: 'rgba(255, 0, 0, 1)',
            backgroundColor: "rgba(255, 0, 0, 0.2)",
            borderWidth: 1,
            fill: false,
            pointRadius: 0
          }]
        },
        options: {
          scales: {
            x: {
              type: 'linear',
              position: 'bottom',
              title: { display: true, text: "賭けた割合[%]" },
              max: 100
            },
            y: {
              title: { display: true, text: '回収率[%]' },
              beginAtZero: true
            }
          },
        }
      })
    }

  </script>
</body>

</html>
